{% extends "base.html" %}

{% block title %}Cálculo Avulso - Portal de Horas{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white text-center">
                <h3 class="mb-0">
                    <i class="fas fa-calculator me-2"></i>
                    Cálculo Avulso de Horas
                </h3>
                <p class="mb-0 mt-2 small">Calcule o valor a pagar com base nas horas trabalhadas</p>
            </div>
            <div class="card-body">
                {% if funcionarios %}
                <form method="POST" id="calculoForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="funcionario" class="form-label">
                                    <i class="fas fa-user me-2"></i>Funcionário *
                                </label>
                                <select class="form-select" id="funcionario" name="funcionario" required>
                                    <option value="">Selecione o funcionário</option>
                                    {% for nome, dados in funcionarios.items() %}
                                    <option value="{{ nome }}" data-valor-hora="{{ dados.valor_hora }}">
                                        {{ nome }} - R$ {{ "%.2f"|format(dados.valor_hora) }}/hora
                                    </option>
                                    {% endfor %}
                                </select>
                                <div id="infoValorHora" class="form-text text-muted mt-2" style="display: none;">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Valor da hora: <strong id="valorHoraDisplay">R$ 0,00</strong>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantidade_horas" class="form-label">
                                    <i class="fas fa-clock me-2"></i>Quantidade de Horas *
                                </label>
                                <input type="number" class="form-control" id="quantidade_horas" 
                                       name="quantidade_horas" step="0.01" min="0" 
                                       placeholder="Ex: 8.5" required>
                                <div class="form-text">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Use ponto para decimais (Ex: 8.5 para 8 horas e 30 minutos)
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-percent me-2"></i>Acréscimo sobre Hora Extra *
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-check-card p-3 border rounded">
                                    <input class="form-check-input" type="radio" name="percentual" 
                                           id="percentual50" value="50" required>
                                    <label class="form-check-label w-100" for="percentual50">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong class="text-warning">50% de acréscimo</strong>
                                                <small class="d-block text-muted">Valor hora × 1,5 (hora + 50%)</small>
                                            </div>
                                            <i class="fas fa-star-half-alt text-warning fa-2x"></i>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-check-card p-3 border rounded">
                                    <input class="form-check-input" type="radio" name="percentual" 
                                           id="percentual100" value="100" checked required>
                                    <label class="form-check-label w-100" for="percentual100">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong class="text-success">100% de acréscimo</strong>
                                                <small class="d-block text-muted">Valor hora × 2,0 (hora + 100%)</small>
                                            </div>
                                            <i class="fas fa-star text-success fa-2x"></i>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prévia do Cálculo -->
                    <div id="previaCalculo" class="alert alert-info" style="display: none;">
                        <h5 class="alert-heading">
                            <i class="fas fa-calculator me-2"></i>Prévia do Cálculo
                        </h5>
                        <div id="detalhePrevia"></div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-calculator me-2"></i>Calcular Valor
                        </button>
                    </div>
                </form>

                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Nenhum funcionário ativo cadastrado. 
                    <a href="{{ url_for('adicionar_funcionario') }}" class="alert-link">
                        Cadastre um funcionário primeiro.
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        {% if resultado %}
        <div class="card shadow mt-4 border-success">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>Resultado do Cálculo
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="text-muted mb-3">
                            <i class="fas fa-user me-2"></i>Funcionário
                        </h5>
                        <p class="h4 text-primary">{{ resultado.funcionario }}</p>
                    </div>
                    <div class="col-md-6">
                        <h5 class="text-muted mb-3">
                            <i class="fas fa-clock me-2"></i>Quantidade de Horas
                        </h5>
                        <p class="h4 text-primary">{{ "%.2f"|format(resultado.quantidade_horas) }}h</p>
                    </div>
                </div>

                <hr class="my-4">

                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <small class="text-muted d-block mb-2">Valor da Hora Base</small>
                            <h5 class="text-dark mb-0">
                                R$ {{ "%.2f"|format(resultado.valor_hora_base) }}
                            </h5>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <small class="text-muted d-block mb-2">Percentual Aplicado</small>
                            <h5 class="text-primary mb-0">
                                {{ resultado.percentual }}
                            </h5>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <small class="text-muted d-block mb-2">Valor da Hora Calculado</small>
                            <h5 class="text-success mb-0">
                                R$ {{ "%.2f"|format(resultado.valor_hora_calculado) }}
                            </h5>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <div class="text-center">
                    <h5 class="text-muted mb-3">
                        <i class="fas fa-hand-holding-usd me-2"></i>Valor Total a Pagar
                    </h5>
                    <div class="alert alert-success p-4">
                        <h1 class="display-3 mb-0 fw-bold">
                            R$ {{ "%.2f"|format(resultado.valor_total) }}
                        </h1>
                        <small class="text-muted d-block mt-2">
                            {{ "%.2f"|format(resultado.quantidade_horas) }}h × R$ {{ "%.2f"|format(resultado.valor_hora_calculado) }}
                        </small>
                    </div>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <a href="{{ url_for('calculo_avulso') }}" class="btn btn-outline-primary">
                        <i class="fas fa-redo me-2"></i>Fazer Novo Cálculo
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Card de Informações -->
        <div class="card shadow mt-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Como Usar
                </h5>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">
                        <strong>Selecione o funcionário:</strong> Escolha o funcionário para o qual deseja calcular o valor
                    </li>
                    <li class="mb-2">
                        <strong>Digite a quantidade de horas:</strong> Informe quantas horas serão pagas (use ponto para decimais)
                    </li>
                    <li class="mb-2">
                        <strong>Escolha o acréscimo:</strong>
                        <ul>
                            <li><strong>50%:</strong> Adiciona 50% ao valor da hora (R$ 20/h vira R$ 30/h)</li>
                            <li><strong>100%:</strong> Dobra o valor da hora (R$ 20/h vira R$ 40/h)</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Clique em Calcular:</strong> O sistema mostrará o valor total a ser pago
                    </li>
                </ol>
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Exemplo:</strong> 5 horas com acréscimo de 50% = 5h × (valor/hora × 1,5)
                </div>
                <div class="alert alert-warning mt-2 mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Importante:</strong> Este cálculo é apenas informativo e não gera registros no sistema.
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-check-card {
    cursor: pointer;
    transition: all 0.3s ease;
}

.form-check-card:hover {
    background-color: #f8f9fa;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-check-card input[type="radio"]:checked + label {
    font-weight: bold;
}

.form-check-card:has(input[type="radio"]:checked) {
    border-color: #0d6efd !important;
    background-color: #e7f1ff;
}
</style>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const funcionarioSelect = document.getElementById('funcionario');
    const quantidadeInput = document.getElementById('quantidade_horas');
    const percentual50 = document.getElementById('percentual50');
    const percentual100 = document.getElementById('percentual100');
    const previaDiv = document.getElementById('previaCalculo');
    const detalhePreviaDiv = document.getElementById('detalhePrevia');
    const infoValorHora = document.getElementById('infoValorHora');
    const valorHoraDisplay = document.getElementById('valorHoraDisplay');

    // Mostrar valor da hora quando selecionar funcionário
    funcionarioSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const valorHora = parseFloat(selectedOption.dataset.valorHora);
            valorHoraDisplay.textContent = `R$ ${valorHora.toFixed(2).replace('.', ',')}`;
            infoValorHora.style.display = 'block';
            calcularPrevia();
        } else {
            infoValorHora.style.display = 'none';
            previaDiv.style.display = 'none';
        }
    });

    // Calcular prévia
    function calcularPrevia() {
        const selectedOption = funcionarioSelect.options[funcionarioSelect.selectedIndex];
        const quantidadeHoras = parseFloat(quantidadeInput.value);
        
        if (selectedOption.value && quantidadeHoras > 0) {
            const valorHoraBase = parseFloat(selectedOption.dataset.valorHora);
            // ACRÉSCIMO sobre o valor base (hora extra)
            const multiplicador = percentual50.checked ? 1.5 : 2.0;
            const percentualTexto = percentual50.checked ? '50% de acréscimo (×1,5)' : '100% de acréscimo (×2,0)';
            const valorHoraCalculado = valorHoraBase * multiplicador;
            const valorTotal = quantidadeHoras * valorHoraCalculado;

            detalhePreviaDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Funcionário:</strong> ${selectedOption.text.split(' - ')[0]}<br>
                        <strong>Horas:</strong> ${quantidadeHoras.toFixed(2)}h<br>
                        <strong>Acréscimo:</strong> ${percentualTexto}
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Valor/hora base:</strong> R$ ${valorHoraBase.toFixed(2)}<br>
                        <strong>Valor/hora c/ acréscimo:</strong> R$ ${valorHoraCalculado.toFixed(2)}<br>
                        <strong class="text-success fs-5">Total: R$ ${valorTotal.toFixed(2)}</strong>
                    </div>
                </div>
            `;
            previaDiv.style.display = 'block';
        } else {
            previaDiv.style.display = 'none';
        }
    }

    // Adicionar listeners
    quantidadeInput.addEventListener('input', calcularPrevia);
    percentual50.addEventListener('change', calcularPrevia);
    percentual100.addEventListener('change', calcularPrevia);
});
</script>
{% endblock %}
{% endblock %}
